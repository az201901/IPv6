# 近隣探索プロトコル

　ICMPv6 を用いて実現される近隣探索プロトコル（ Neighbor Discovery Protocol ）は、 IPv6
の根幹となる非常に大きな特徴であある。

# 7.1　近隣探索プロトコルの機能と利用するメッセージ

　RFC 4861 では、近隣探索プロトコルが提供する機能を以下のように要約しています。

```
・リンク上のルータを探す機能（ Router Discovery ）  
・ルータを経由せずに到達できる IPv6 アドレスの範囲を知る機能（ Prefix Discovery ）  
・リンクの MTU などの情報を知る機能（ Parameter Discovery ）
・インターフェースに対してステートレスにアドレスを振る機能（ Address Autoconfigura-
tion ）
・IPv6 アドレスからリンク層のアドレスを解決する機能（ Address Resolution ）
・宛先アドレスをもとに、次にパケットを送出すべき IPv6 アドレスを知る機能（ Next-hop
Determination ）
・近隣ノードに到達できなくなったことを知る近隣不到達性検知 （ Neighbor Unreachability
Detection ）
・利用するアドレスが他のノードで使われていないかを確認する機能（ Duplicate Address
Detection ）
・ルータからホスト † 3 へ、より適切な送出先を伝える方法（ Redirect 
```

　上記の機能を実現するために、近隣探索プロトコルでは、次の 5 つの ICMPv6 メッセージを
組み合わせて利用します。
```
・Router Advertisement メッセージ（ 7.2.1 項）
・Router Solicitation メッセージ（ 7.2.2 項）
・Neighbor Solicitation メッセージ（ 7.3.1 項）
・Neighbor Advertisement メッセージ（ 7.3.2 項）
・Redirect メッセージ（ 7.4 節）
```

# 7.2　ルータとプレフィックス情報の発見

　ルータでは、ネットワーク設定に必要な情報を含む Router Advertisement
を、定期的にマルチキャストで送信します。これにより、そのルータのサブネットに接続して
いる機器は、そのサブネットを利用した通信を行うために必要な情報を得られます。

　 Router Solicitation メッセージを送ることにより、 Router Advertisement メッセージ
を直ちに受け取ることも可能です。

## 7.2.1　Router Advertisement メッセージ

　Router Advertisement は、タイプ 134 の ICMPv6 メッセージです。

　RA を運ぶ IPv6 パケットの IPv6 ヘッダでは、送信元 IPv6 ア
ドレスに、送信に使われるネットワークインターフェースに設定されたリンクローカル IPv6
アドレスを指定する必要があります。

　Router Advertisement メッセージを運ぶ IPv6 パケットでは、 IPv6 ヘッダの宛先 IPv6 アド
レスとして、通常は全ノードマルチキャストアドレス（ ff02::1 ）を指定します。 Router
Solicitation メッセージに対する返答の場合は、 Router Solicitation メッセージに記載された
送信元 IPv6 アドレスを指定します。

　前述したように、 Router Advertisement メッセージを運ぶ IPv6 パケットでは、 IPv6 ヘッ
ダの Hop Limit の値を 255 にします。これにより、他のリンクに接続された機器から誤って
Router Advertisement メッセージが転送されてきても、その内容に影響されないようにでき
ます。

![図7.3](img/07_03.jpg)

* Cur Hop Limit  
　そのルータを通じて転送されていく IPv6 パケットの Hop Limit フィールドについて、ルー
タが推奨する値を示します。値は 8 ビットの符号なし整数で指定します。ルータによって特に推奨値を指定しない場合は、 0 にします。

| ビット位置 | 記号 | 意味 |
| --- | --- | --- |
| 40 | M | 「 Managed address configuration 」を意味するフラグです。 DHCPv6 による IPv6 アドレス設定が利用可能であることを示すためのフラグです。 DHCPv6 による IPv6 アドレス設定が利用可能である場合に、このフラグが 1 に設定されます。|
| 41 | O | 「 Other configuration 」を示すフラグです。 IPv6 アドレス以外の情報を DHCPv6 で取得することが可能である場合は、このフラグを 1 に設定します。たとえば、 DNS に関連する情報が DHCPv6 で提供されている場合には、このフラグを設定します。 |  
| 42 | H | 「 Mobile IPv6 Home Agent 」を示すフラグです。 RFC 3775 で定義されています。|
| 43 | Prf | 「 Default Router Preference 」を示すフラグです。 RFC 4191 で定義されています。 |
| 45 | P | 「 Neighbor Discovery Proxy 」を示すフラグです。 RFC 4389 で定義されています。 |
| 46 | - | 予約 |
| 48 | Router Lifetime | 自分がデフォルトルータとして有効な期間をホストに伝えるためのフィールドです。 16ビットの符号なしの整数により、秒単位で指定します。このフィールドの値が 0 である場合は、自身をデフォルトルータとして利用してはならないことをホストに対して示します |
| 64 | Reachable Time | 近隣不到達性検知アルゴリズムで使われるフィールドです。 32 ビットの符号なしの整数です。単位はミリ秒です。 0 は、このルータでは未定義という意味を持ちます。 |
| 96 | Retrans Timer | ホストに対して Neighbor Solicitation メッセージの再送信まで待つべき時間を指定するフィールドです。ミリ秒単位で 32 ビットの符号なしの整数を指定します。 0 は、そのルータでは未定義という意味を持ちます。 |

*  Options （可変長）  
　近隣探索メッセージのためのオプション（ 7.5 節で説明します）を含めるフィールドです。
Router Advertisement メッセージに含められるのは、 RFC 4861 で定義されている Source
Link-layer Address オプション（ 7.5.2 項） 、 MTU オプション（ 7.5.5 項） 、 Prefix Information オプション（ 7.5.3 項）のほか、 RFC 8106 † 8 で定義されている RDNSS オプション（ 7.5.6
項） 、 DNSSL オプション（ 7.5.7 項）などです。

　RFC 4861 では、RA に含まれるフラグは M と O のみであり、
残りの 6 ビットが予約（ Reserved ）と定義されています。そして、その予約フィールド内の
値として 0 を設定するように求めています。しかし、 RFC 3775 で H フラグが定義され、また
RFC 4191 で Prf として 2 ビットが使われることになっており、さらに RFC 4389 では P フラグ
が定義されています。

　RA に含まれるフラグについては、上記の状況を整理し、さ
らに必要な場合にフラグを拡張できるように、 Flags Expansion というオプションを定義した
RFC 5175 が発行されています。

## 7.2.2　Router Solicitation メッセージ

　IPv6 ノード側からルータに対して
Router Advertisement をただちに送信するように要求するために、 この Router Solicitation
メッセージを使います。

 IPv6 アドレスの自動設定を行うときなど、まだ IPv6 アドレスが設定されてい
ない場合には、送信元 IPv6 アドレスとして、未定義アドレス（ ::/128 ）を使うことになっています。

　Router Solicitation メッセージを運ぶ IPv6 パケットでは、 IPv6 ヘッダの宛先 IPv6 アドレス
として、通常は全ルータマルチキャストアドレス（ ff02::2 ）が使われます。

　Router Solicitation メッセージを運ぶ IPv6 パケットでは、 Router Advertisement メッセー
ジと同様に、 IPv6 ヘッダの Hop Limit の値を 255 とします。

![図7.4](img/07_04.jpg)

* 予約（ 32 ビット）  
　未使用領域です。このフィールドの値は 0 であることが求められます。受信側は、この
フィールドの内容を無視する必要があります。

* Options （可変長）  
　近隣探索メッセージのためのオプション（ 7.5 節）を含めるフィールドです。
Router Solicitation メッセージに含められるのは、 RFC 4861 で定義されている Source
Link-layer Address オプション（ 7.5.2 項）です。なお、送信元アドレスが未定義アドレス
の場合は、オプションを含めることが禁止されています。

## 7.2.3　ルータ側の処理

　Router Advertisement により、ルータとしてパケットを転送するネット
ワークプレフィックス情報や、デフォルトルータであるかどうかといった情報などをホストに
対して送信します。

　システムのシャットダウンするなどの理由により送信をやめる場合は、 Router Lifetime をゼロに設定し
た Router Advertisement メッセージを送信すべきとされています。

■ ルータのリンクローカルアドレスが変わる場合

　近隣探索プロトコルでは、ルータのリンクローカルアドレスを利用して、そのリンク内で
ルータを識別します。そのため、ルータのリンクローカルアドレスを変更すべきではありま
せん。

　RFC 4861 では非推奨としつつも、ルータのリ
ンクローカルアドレスが変わる場合には、ただちにその変更を通知するために、古いリンク
ローカルアドレスで Router Lifetime をゼロに設定した Router Advertisement メッセージを
いくつか送信し、 そのうえで、 新しいリンクローカルアドレスを使った Router Advertisement
メッセージを送信することが推奨されています。

## 7.2.4　ホスト側の処理

　ホストは、ルータがデフォルトルータとしての有効期限が過ぎる前に新たな Router
Advertisement メッセージによって有効期限を更新しない場合、自身の Default Router List
からそのルータに関するエントリを削除する必要があります。

# 7.3　リンク層アドレスの解決と近隣不到達性の検知

> NOTE  
> 　Neighbor Solicitation と Neighbor Advertisement は、 SLAAC で
定義されている DAD （ Duplicate Address Detection 、重複アドレス検知）でも利用さ
れます。 DAD に関しては、 8.5 節で説明します。

## 7.3.1　Neighbor Solicitation メッセージ

　Neighbor Solicitation メッセージは、リンク層アドレスの解決を行う場合にはマルチキャ
ストで送信されます。その際、 IPv6 ヘッダの宛先 IPv6 アドレスとしては、 Target Address
フィールドに指定する値に対応した Solicited-Node マルチキャストアドレス（ 12.3 節参照）を
指定することになります。

　近隣不到達性検知の場合は、対象となる IPv6 ノードを宛先とするユニキャストで送信され
ます。

![図7.5](img/07_05.jpg)

* Target Address （128 ビット）  
　対象となる IPv6 アドレスです。このフィールドにマルチキャストアドレスを記載すること
は禁止されています。

* Options （可変長）  
　近隣探索メッセージのためのオプション（7.5 節で説明します）を含めるフィールドです。
Neighbor Solicitation メッセージには、 Source Link-layer Address オプションを使って、
送信者のリンク層アドレスを含めることができます。

## 7.3.2　Neighbor Advertisement メッセージ

　NA は、 NS への返答として送信されます。設定情報を更新したときに、
それを即座に伝搬させるため、IPv6 ノードが自発的に NA を送信することもあります。

　NS に返答する場合は、NS の送信元アドレスによって、返答 NA の宛先が変わります。
NS の送信元 IPv6 アドレスが未定義アドレスではない場合、そのアドレスへ NA が送信されます。

　NS 送信元アドレスが未定義アドレスである場合は、全ノードマルチ
キャスト宛に、返答 NA が送信されます。

　自発的に NA を送信する場合は、全ノードマルチキャスト宛（ ff02::1 ）に送信します。

![図7.6](img/07_06.jpg)

* R ビット  
　ルータであることを示すためのフラグです。このフラグが 1 であるとき、送信元がルータで
あることを示します。

* S ビット  
　NS に対する返答であることを示します。
近隣不到達性検知では、このフラグを使います。NA の宛先がマルチキャストの場合や、
自発的なユニキャスト送信の場合は、 S フラグを 1 にすることが禁止されています。

* O ビット  
　Override を意味するフラグで、近隣キャッシュに登録されているリンク層アドレス情報の
上書きを推奨する場合には 1 に設定します。このフラグが設定されていない場合には、リン
ク層アドレスが近隣キャッシュに登録済みのエントリが NA の情報で更新されることはありません。
エニーキャストでは、このフラグを 1 にしないことが推奨されています。

* Target Address（128 ビット）  
　NS に対する返答の場合、 NS の Target Address フィールドに記載されている IPv6 アドレスになります。
リンク層アドレスの変更を伝える自発的な NA の場合は、このフィールド
に、変更のあったリンク層アドレスに対応する IPv6 アドレスが入ります。 Target Address
フィールドをマルチキャスト IPv6 アドレスにすることは禁止されています。

* Options（可変長）  
　近隣探索メッセージのためのオプション（ 7.5 節で説明します）を含めるフィールドです。

## 7.3.3　Solicited-Node マルチキャストグループへの参加

　内容なし

## Neighbor Solicitation と Neighbor Advertisement の送受信

　 IPv6 アドレスからリンク層アドレスへの対応は、近隣キャッシュ（ Neighbor Cache ）
として、各ノードで管理しています。

　もし近隣キャッシュに対応する IPv6 アドレスのリンク層アドレスがなければ、ノードは NS を送信します。
この NS を送信する IP パケットの宛先 IPv6 アドレスは、ネットワークインターフェースがマルチキャスト
利用可能なものであれば、 Solicited-Node マルチキャストアドレスになります。

　NS による問い合わせがあると、該当する IPv6 アドレスが設
定されているネットワークインターフェースを持つノードは、ユニキャストで NA メッセージを返信します。
この NA に届くことで、そのノードはリンク層アドレスを解決できるようになります。

　あるノードが NS 送信し、NA を受け取るまでの流れは次のようになる。

　ノードでは、リンク層アドレスがわからない IPv6 パケットの送信をトリガーとして、
NS を送信する。トリガーとなった IPv6 パケットはキューに保存する。
NS を送信すると同時に、該当する IPv6 アドレスのためのエントリを近隣キャッシュに生
成する。リンク層アドレスはわからない状態なので、このエントリは「 INCOMPLETE （不完全） 」とする。
NA を受け取ったら、受け取った情報で近隣キャッシュを更新する。

　ホストごとに設定された時間だけ待っても NS に対して応答がない場合、NSを再送する。
一定の回数だけ再送しても NA を受け取れない場合は、キューに保存していた IPv6 パ
ケットに対して ICMP Destination Unreachable メッセージを Code 3 （ Address Unreachable ）
で返す。

## 7.3.5　近隣不到達性検知

　近隣不到達性検知には、次の 2 種類があります。

* 上位層のプロトコルにおける応答  
　たとえば TCP で通信相手のノードからACK を受け取った場合が挙げられます。

* NS に対する NA の応答
　NA の S フラグが 1 に設定されていれば、 こちらから送った NS が相手に届いたことに対する応答だとわかる。
S フラグが 0 に設定されている NA を受け取ったりしても、それ
らの近隣探索メッセージの送信元ノードへの到達性を確認するものとみなされません。
近隣不到達性にとって問題になるのは、あくまでも自ノードから次ホップとなる近隣ノードへ到
達できなくなっていないかどうかなのです。

> NOTE  
> 近隣不到達性検知は、ユニキャストで IPv6 パケットを送信するときに同時に実施され
るものです。宛先がマルチキャストアドレスの場合には実施されません。
